{% extends "base.html" %}
{% block title %}{% if tpl %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω{% else %}–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %}{% endblock %}
{% block content %}
<h3>{% if tpl %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω{% else %}–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %}</h3>

<form method="post" id="templateForm">
    {{ form.hidden_tag() }}

    <div class="mb-3">
        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–ø—Ä–∞–≤–∫–∞ –æ–± –æ–±—É—á–µ–Ω–∏–∏") }}
    </div>

    <div class="mb-3">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control", rows="2", placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞") }}
    </div>

    <div class="mb-3">
        <label class="form-label">–¢–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞</label>
        <div class="small text-muted mb-2">
            –ü–∏—à–∏—Ç–µ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –≥–æ—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤.
        </div>

        <div class="mb-2">
            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="insertVariable('–§–ò–û')">–§–ò–û</button>
            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="insertVariable('–¥–∞—Ç–∞')">–î–∞—Ç–∞</button>
            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="insertVariable('–¥–æ–ª–∂–Ω–æ—Å—Ç—å')">–î–æ–ª–∂–Ω–æ—Å—Ç—å</button>
            <button type="button" class="btn btn-outline-primary btn-sm me-1" onclick="insertVariable('–ø–æ–¥–ø–∏—Å—å')">–ü–æ–¥–ø–∏—Å—å</button>
            <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="insertCustomVariable()">+ –°–≤–æ—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è</button>
            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#blocksModal">
                üß© –í—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫
            </button>
        </div>

        {{ form.template_text(class="form-control", rows="15", id="templateText") }}
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
        <a href="{{ url_for('templates_list') }}" class="btn btn-outline-secondary">–û—Ç–º–µ–Ω–∞</a>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal fade" id="blocksModal" tabindex="-1" aria-labelledby="blocksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blocksModalLabel">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥–æ—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>–£—á–µ–±–Ω—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</h6>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –±—é–¥–∂–µ—Ç–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ –≤—ã—Å—à–µ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è ¬´{{ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç }}¬ª')">–§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –±—é–¥–∂–µ—Ç–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ –≤—ã—Å—à–µ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è ¬´{{ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç }}¬ª</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –±—é–¥–∂–µ—Ç–Ω–æ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ ¬´{{ –∫–æ–ª–ª–µ–¥–∂ }}¬ª')">–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–µ –±—é–¥–∂–µ—Ç–Ω–æ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ ¬´{{ –∫–æ–ª–ª–µ–¥–∂ }}¬ª</button>
                    </div>

                    <div class="col-md-6 mb-3">
                        <h6>–î–æ–ª–∂–Ω–æ—Å—Ç–∏</h6>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–†–µ–∫—Ç–æ—Ä {{ —Ä–µ–∫—Ç–æ—Ä }}')">–†–µ–∫—Ç–æ—Ä {{ —Ä–µ–∫—Ç–æ—Ä }}</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–î–µ–∫–∞–Ω —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ {{ –¥–µ–∫–∞–Ω }}')">–î–µ–∫–∞–Ω —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ {{ –¥–µ–∫–∞–Ω }}</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–ó–∞–≤–µ–¥—É—é—â–∏–π –∫–∞—Ñ–µ–¥—Ä–æ–π {{ –∑–∞–≤_–∫–∞—Ñ–µ–¥—Ä–æ–π }}')">–ó–∞–≤–µ–¥—É—é—â–∏–π –∫–∞—Ñ–µ–¥—Ä–æ–π {{ –∑–∞–≤_–∫–∞—Ñ–µ–¥—Ä–æ–π }}</button>
                    </div>

                    <div class="col-md-6 mb-3">
                        <h6>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã</h6>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å')">–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏')">–Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('—Å—á–∏—Ç–∞—é –Ω—É–∂–Ω—ã–º –æ—Ç–º–µ—Ç–∏—Ç—å')">—Å—á–∏—Ç–∞—é –Ω—É–∂–Ω—ã–º –æ—Ç–º–µ—Ç–∏—Ç—å</button>
                    </div>

                    <div class="col-md-6 mb-3">
                        <h6>–ü–æ–¥–ø–∏—Å–∏</h6>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–ú.–ü.')">–ú.–ü.</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('__________________')">__________________</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm d-block mb-1" onclick="insertBlock('–≥. {{ –≥–æ—Ä–æ–¥ }}, {{ –¥–∞—Ç–∞ }}')">–≥. {{ –≥–æ—Ä–æ–¥ }}, {{ –¥–∞—Ç–∞ }}</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% raw %}
<script>
    function insertAtCursor(textarea, text) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        textarea.value = value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
    }

    function insertVariable(name) {
        const textarea = document.getElementById('templateText');
        insertAtCursor(textarea, '{{ ' + name + ' }}');
    }

    function insertCustomVariable() {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π –∏–ª–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤):\n–ü—Ä–∏–º–µ—Ä: –Ω–æ–º–µ—Ä_–ø—Ä–∏–∫–∞–∑–∞, –§–ò–û_—Å—Ç—É–¥–µ–Ω—Ç–∞");
        if (name && name.trim()) {
            const cleanName = name.trim().replace(/[^\w–∞-—è–ê-–Ø—ë–Å]/g, '_');
            insertVariable(cleanName);
        }
    }

    function insertBlock(text) {
        const textarea = document.getElementById('templateText');
        insertAtCursor(textarea, text);
        const modal = bootstrap.Modal.getInstance(document.getElementById('blocksModal'));
        modal.hide();
    }
</script>
{% endraw %}
{% endblock %}
